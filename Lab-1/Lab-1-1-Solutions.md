# Lab1-1 Sorular

Bu lab uygulamasında `Practical Malware Analysis` kitabıyla birlikte verilmiş olan `Lab01-01.exe` ve `Lab01-01.dll` dosyaları üzerinden analiz gerçekleştirilecek ve sorulan sorularak cevaplar verilmeye çalışılacaktır. 

Bu içeriklerin amacı, direkt olarak sorulan sorulara cevap vermek değil, aynı zamanda malware analizi konusunda aydınlatıcı ve faydalı bir içerik havuzu oluşturmaktadır. Gerektiği yerlerde detaya girilecektir. Zaten kitabı aldıysanız, kitabın bir bölümü bu soruların cevaplarını detaylı bir şekilde veriyor. Burada amaç, cevapların içerisinde gizli kalmış, değinilmesi gereken konulara da değinerek bir fayda sağlabilmek. O halde başlayalım.

İlk sorumuz,

1- Upload the files to http://www.virustotal.com/ and view the reports. Does either file match any existing antivirus signatures? Şeklinde.

Burada dosyaları virustotal'e yükleyip, çıkan sonucu analiz etmemiz istenmektedir. Dosyaları sırasıyla virustotal'e upload ettiğimizde Lab01-01.dll dosyası için 36 adet, Lab01-01.exe için ise de 42 adet antivirüs engine'i zararlı olarak uyarı vermektedir. Virustotal'i açıklamak gerekir ise, zararlı yazılım analizcilerinin çok sevdiği ve siber güvenlik dünyasında önemli yeri olan bir oluşumdur. Virustotal bünyesinde, zararlı yazılımlara ait ciddi bir veritabanı barındırmaktadır. Şüpheli bir dosyayı virustotal üzerinden tarattırıp, zararlı olup olmadığını öğrenebilirsiniz. Virüstotal arkaplanda 100'e yakın antivürüs motoruna bu şüpheli dosyayı tarattırıp, size oldukça detaylı bilgiler verecektir.

2- When were these files compiled?

Virüstotal'deki sonuçlara bakarak, bu dosyaların hiçte masum olmadıklarını rahatlıkla söylebiliriz. Artık daha detaylı bir şekilde analizimize devam etmemiz gerekmektedir. Bu sebeple bu soruda bizden, bu dosyaların ne zaman compile edildiğini sormaktadır. Bu neden önemli diye soracak olursanız, bir binary'nin compile edilme zamanı bize `o zararlının ne zaman ortaya çıktığı hakkında` bir ipucu vermektedir. Diyelim ki elinizde şüphelendiğiniz bir dosya var, eğer bu dosya zararlı ve eski bir dosya ise, internet üzerinden bu dosyayı tespit etmek için gerekli IOC'lerin paylaşılma olasılığı oldukça yüksektir. Bu sebepten dolayı derlenme zamanı ufakta olsa faydalıdır. Lakin bazı malware geliştiricileri, bu compile time'ı değiştirerek analistleri yanıltabilmektedir. Bu compile time'ı değiştirmek ise oldukça basittir. Tek yapılması gereken PE dosyas formatında `file-header` kısmından `compiler-stamp` bölümünü manipüle etmek. Her neyse, konu oldukça uzadı. Binary'lerin compiler zamanını öğrenmek için `CFF Explorer` veya `PEstudio` gibi uygulamaları kullanabilirsiniz. Tabi dosyalarınız PE formatında yani Portable Executable formatında ise. Eğer linux'taki binary formatı olan ELF ise, bu iki uygulama işe yaramayacaktır.

Lab01-01.dll compiler-time: 0x4D0E2FE6 (Sun Dec 19 19:16:38 2010- UTC)
Lab01-01.exe compiler-time: 0x4D0E2FD3 (Sun Dec 19 19:16:19 2010- UTC)

3- Are there any indication that either of these files is packed or obfuscated? If so, what are these indicators?

Bu soruda ise bizden bu dosyaların packed veya obfuscated olup olmadıklarını sormaktadır. Eğer böyle bir durum var ise, bunu tespit edecek veriler neler belirtmemizi istemektedir.

Bu iki dosyada da, bir packed veya obfuscate edilmiş kısım bulunmamaktadır. Bunu basit bir yöntem olan `PEiD` uygulaması ile rahatlıkla öğrenebilirsiniz. Dosyalarını bu uygulamaya import ettğiniz vakit, eğer bir paketleme söz konusu ise size bunu detaylı bir şekilde(hangi paketleme yöntemi olduğu bilgisi) belirtmektedir. Biraz daha detaylı bir açıklama yapacak olursak, bir binary içerisindeki kısımlar paketlenmiş ise veya obfuscate edilmiş ise, içini incelemeye başladığınız vakit birçok `import ve export değerini` **göremezsiniz.** Binary hakkında detay barındıran ve işimize oldukça yarayan string ifadeleri göremezsiniz. Şuan uygulamayı linux'taki `string Lab01-01.dll` komutu ile incelediğim vakit, rahatlıkla `Kernel32.DLL, WS2_32.DLL ve MSVCRT.DLL` dosyalarının import edildiğini görebilmekteyim. Ayrıca bu DLL dosyaları içerisinden hangi fonksiyonlar import edilmiş onlarda rahatlıkla gözükmektedir. Mesela kernel32.dll dosyasından CloseHandle, CreateMutexA, CreateProcessA, OpenMutexA, Sleep fonksiyonları import edilmiş. Eğer binary'imiz obfuscated edilmiş olsa veya bir packer ile paketlemiş olsa bunların hiçbirini static analiz ile göremeyecektik. Aşağıdaki görselde packed ve normal binarylerin yapısı gösterilmektedir.

![](/images/packed.png "packed-png")

4- Do any imports hint at what this malware does? If so, which imports are they?

Bu soruda ise bizden, bu malware'in karakteristiği hakkında ipucu veren import'lar nelerdiri istemektedir. Bir önceki soruda Lab01-01.dll dosyasının hangi DLL'leri import ettiğini söylemiştik. Lab01-01.exe'de `Kernel32.dll` ve `msvcrt.dll` dosyalarını import etmektedir. Aşağıdaki görselde Lab01-01.exe dosyasında kernel32.dll'inden import edilmiş bazı fonksiyonlar gözükmektedir. Bu fonksiyonlar bize malware'in karakteristiği hakkında bilgiler vermektedir. Mesela dosya arama, dosya kopyalama ve dosya oluşturma gibi işlemler için fonksiyonlar bulunmaktadır. Ayrıca Lab01-01.dll dosyası içerisindeki CreateProcess ve Sleep fonksiyonları da hiç masum gözükmemektedir.

![](/images/Lab1-1-image.png "imports")

Ayrıca lab01-01.dll dosyasında ise  WS2_32.dll dosyası import edilmiştir. Bu DLL dosyasının hizmeti aşağıdaki gibidir.

> File that contains the Windows Sockets API used by most Internet and network applications to handle network connections.

Özetle network bağlantıları için kullanılan bir DLL dosyası. Buda aslında bize, malware'in belirli işlemlerden önce veya sonra bir yerlere network üzerinden erişmeye çalıştığına dair bir ipucu vermektedir. Aşağıdaki görselde ordinal numberlar üzerinden WS2_32.dll dosyasından import edilmiş fonksiyonları göstermektedir.

![](/images/Lab1-1-image2.png "imports")

5- Are there any other files or host-based indicators that you could look for on infected systems?

Bu soruda ise bizden host tabanlı bu malware'i tespit edebileceğim indicator'ler var mı diye sormaktadır. Lab01-01.exe dosyası içerisindeki string ifadeler baktığımız vakit, `C:\windows\system32\kerne132.dll` şeklinde bir ifade görmekteyiz. Dikkat edilirse kerne*l*32.dll yerine kernel**1**32.dll ifadesi kullanılmış. Belki zararlı yazılımımız burada böyle bir dosya oluşturmakta ve orjinal dosyayı buna kopyalacaktır. Şuan tamamen tahmin ediyorum, belkide başka birşey. Bunu dinamik analiz veya advanced static analiz yapmadan bilemeyiz. Her neyse, ilk olarak bu indicator'u belirtebiliriz. İkinci olarak ise `C:\Windows\System32\Kernel32.dll` dosyası belirtilebilir. Bir diğer dikkat çekici ifade ise `WARNING_THIS_WILL_DESTROY_YOUR_MACHINE` ifadesi. Bu zararlının uygulama içerisinde bir uyarı mesajı olarak gösterdiği bir ifadedir. Bu tarz error veya warning uyarıları, bizlere önemli bilgiler verebilmektedir. Son olarakta, Lab01-01.exe dosyasının çalışması için Lab01-01.dll dosyasına ihtiyaç duyduğudur. Bu ifade de string olarak geçmektedir. Bir ayrı indicator olarak bu da belirtilebilir. Bu dosyanın varlığı yani `Lab01-01.dll dosyasının varlığı`, malware tespitinde önemli bir ipucudur.

6- What network-based indicators could be used to find this malware on infected machines?

Bu soruda ise bu malweri tespit edebileceğimiz network tabanlı indicator'leri sormaktadır. Lab01-01.dll dosyasını incelediğimiz vakit `127.26.152.13` IP adresine ulaşmaktayız. Bu IP adresi bizim için oldukça önemli bir done'dir. 

7- What would you guess is the purpose of these files?

Bu yapılan analizler sonucunda bu zararlıların amacına dair şu yorumu yapabiliriz.

- Malware çalıştıktan sonra bazı dosyaları arayıp, bir yere kopyalabilir veya manipüle edebilir. Aradığı dosyalar büyük ihtimalle `exe` uzantılı dosyalar. Bunu ise string ifadeler içerisindeki `.exe` indicatorüne dayanarak söylüyorum. Büyük ihtimalle'de `C:\*` ifadesine bakarak, bu exe dosyaları `C dizini` altında aramaktadır. Arama yaptığını ise kernel32.dll dosyasından import ettiği, `FindFirstFileA` ve `FindNextFileA` gibi fonksiyonlardan görebilmekteyiz.

- WS2_32.dll dosyasının import edilmesi ise, bize bu zararlının bir backdoor olabileceği yorumunu yaptırmaktadır. Belkide gelen komutlar üzerinden bazı dosyları arayıp, kopyalayıp, orjinalini manipüle edip `127.26.152.13` IP adresine göndermektedir. Bu sorulara cevap verebilmek için daha derin bir araştırma yapmak gerekmektedir.  
