# Lab6-4 Sorular

Bu lab uygulamasında `Practical Malware Analysis` kitabıyla birlikte verilmiş olan `Lab06-04.exe` dosyası üzerinden analiz gerçekleştirilecek ve sorulan sorularak cevaplar verilmeye çalışılacaktır. 

Bu içeriklerin amacı, direkt olarak sorulan sorulara cevap vermek değil, aynı zamanda malware analizi konusunda aydınlatıcı ve faydalı bir içerik havuzu oluşturmaktadır. Gerektiği yerlerde detaya girilecektir. Zaten kitabı aldıysanız, kitabın bir bölümü bu soruların cevaplarını detaylı bir şekilde veriyor. Burada amaç, cevapların içerisinde gizli kalmış, değinilmesi gereken konulara da değinerek bir fayda sağlabilmek. O halde başlayalım.

İlk sorumuz,

**1- What is the difference between the calls made from the main method in Labs 6-3 and 6-4?**

Lab6-4 ile Lab6-3 arasındaki fonksiyon çağrılarındaki en temel fark, Lab6-4'de fonksiyonlar bir döngü içerisinde çağırılmakta, Lab6-3'te ise bir kere çağrılmaktadır. Ayrıca Lab06-04.exe'de `sub_401040` fonksiyonu çağrılırken parametre olarak [ebp+var_8] değeri verilmektedir. Lab06-03.exe'de böyle bir parametre verilmesi gözükmemektedir.

**2- What new code construct has been added to main?**

Main fonksiyonumuza yeni olarak `for` döngüsü eklenmiştir. Aşağıdaki bloktaki `loc_401251` kısmı sürekli  var_C değerini arttırmak ve `loc_40125A` kısmıdanki **jge** koşullu ifadesi ile bu değerin **5A0h** değerinden büyük olup olmadığı kontrol edilmektdir. 

```assembly
.text:00401251
.text:00401251 loc_401251:                             ; CODE XREF: _main+7D↓j
.text:00401251                 mov     eax, [ebp+var_C]
.text:00401254                 add     eax, 1
.text:00401257                 mov     [ebp+var_C], eax
.text:0040125A
.text:0040125A loc_40125A:                             ; CODE XREF: _main+1F↑j
.text:0040125A                 cmp     [ebp+var_C], 5A0h
.text:00401261                 jge     short loc_4012AF
.text:00401263                 mov     ecx, [ebp+var_C]
.text:00401266                 push    ecx
.text:00401267                 call    sub_401040
.text:0040126C                 add     esp, 4
.text:0040126F                 mov     [ebp+var_8], al
.text:00401272                 movsx   edx, [ebp+var_8]
.text:00401276                 test    edx, edx
.text:00401278                 jnz     short loc_40127E
.text:0040127A                 xor     eax, eax
.text:0040127C                 jmp     short loc_4012B1
.text:0040127E ; ---------------------------------------------------------------------------
.text:0040127E
.text:0040127E loc_40127E:                             ; CODE XREF: _main+48↑j
.text:0040127E                 movsx   eax, [ebp+var_8]
.text:00401282                 push    eax
.text:00401283                 push    offset aSuccessParsedC ; "Success: Parsed command is %c\n"
.text:00401288                 call    sub_4012B5
.text:0040128D                 add     esp, 8
.text:00401290                 mov     ecx, [ebp+argv]
.text:00401293                 mov     edx, [ecx]
.text:00401295                 push    edx             ; lpExistingFileName
.text:00401296                 mov     al, [ebp+var_8]
.text:00401299                 push    eax             ; char
.text:0040129A                 call    sub_401150
.text:0040129F                 add     esp, 8
.text:004012A2                 push    0EA60h          ; dwMilliseconds
.text:004012A7                 call    ds:Sleep
.text:004012AD                 jmp     short loc_401251
```

**3- What is the difference between this lab's parse HTML function and those of the previous labs?**

Önceki lab'lar ile bu lab arasındaki parse HTML fonksiyonundaki fark, bu lab'ta parametre verilmektedir. Ayrıca bu verilen parametre **\_sprintf** fonksiyonu ile "Internet Explorer 7.50/pma %d" ifadesinde yazdırılmaktadır.

**4- How long will this program run? (Assume that it is connected to the internet.)**

2. Soruda belirtilen kod bloğunda dikkat edilmesi gereken iki kısım var. İlk olarak bir döngünün varlığı ve bu döngü içerisinde çağırılan `Sleep` fonksiyonu. Hesaplamamız, **döngü sayısı\*sleep(dwMilliseconds)** ifadesine göre olacaktır. Çünkü soruda, malware'in internete bağlandığını kabul edin diyor. Eğer internete bağlanmaz ise, döngü kesilip program sonlandırılacaktır. Bu değerlendirmelere göre hesap yaptığımızda, `cmp     [ebp+var_C], 5A0h` ifadesindeki **5A0h** ifadesi bizim döngümüzün üst limitidir. Decimal karşılğı **1440**'dır. Sleep fonksiyonumuz ise her seferinde **0EA60h** değerini almaktadır. Decimal değeri ise **60000**'dir. Cevabımız 60000\*1440 = 86400000 milisaniyedir. Bu da 1440 dakika yani 24 saat yapmaktadır.

**5- Are there any new network-based indicators for this malware?**

Web sitesine istek yapılırken kullanılan User-Agent değeri değişmiştir. Yeni olarak bu değişiklik söylenebilir.

**6- What is the purpose of this malware?**

Bir önceki örneklerden farklı bir amacı yoktur. Sadece kod yapısında bazı değişiklikler olmuştur, lakin amaç aynıdır.



