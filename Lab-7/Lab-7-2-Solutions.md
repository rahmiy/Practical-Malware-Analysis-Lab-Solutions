5# Lab7-2 Sorular

Bu lab uygulamasında `Practical Malware Analysis` kitabıyla birlikte verilmiş olan `Lab07-02.exe` dosyası üzerinden analiz gerçekleştirilecek ve sorulan sorularak cevaplar verilmeye çalışılacaktır. 

Bu içeriklerin amacı, direkt olarak sorulan sorulara cevap vermek değil, aynı zamanda malware analizi konusunda aydınlatıcı ve faydalı bir içerik havuzu oluşturmaktadır. Gerektiği yerlerde detaya girilecektir. Zaten kitabı aldıysanız, kitabın bir bölümü bu soruların cevaplarını detaylı bir şekilde veriyor. Burada amaç, cevapların içerisinde gizli kalmış, değinilmesi gereken konulara da değinerek bir fayda sağlabilmek. O halde başlayalım.

İlk sorumuz,

**1- How does this program achive persistence?**

Program incelendiğinde persistence sağlayacak bir algoritma veya yöntem bulunmadığı görülmüştür.

**2- What is the purpose of this program?**

Bu programın amacı `http://www.malwareanalysisbook.com/ad.html` adresine bağlanmaktır. Yalnız bu adrese bağlanırken standart WINAPI kullanmak yerine COM yani **Component Object Model** teknolojisini kullanmaktadır. Bu teknoloji farklı veya aynı programlama dilleri kullanılarak oluşturulmuş yazılımların, birbilerine ait fonksiyonları kendi içlerinde kullanmasına imkan tanıyan bir teknolojidir. Mesela X ve Y uygulamaları olsun. Bu iki uygulama Z uygulamasının COM teknolojisine uygun olarak geliştirilmiş printf() fonksiyonunu COM teknolojisini kullanarak çağırabilir ve kendi fonksiyonları içerisinde rahatlıkla kullanabilir.Tabi burada OOP standartları içerisinde bulunan Interface kavramınıda anlamak gerekmektedir. COM bir interface standartıdır. 

Zararlı yazılımlar genelde internet explorer'ın COM kullanılarak diğer yazılımlara açılmış fonksiyonlarını kullanırlar. Bu uygulamada da aynı işlem yapılmıştır. Aşağıdaki kod bloğunda `OleInitialize` ve `CoCreateInstance` API çağrıları, zararlımızın bir COM nesnesini kullanacağını göstermektedir. Hangi uygulamanın hangi interfacesi kullanılacak bunu da, CoCreateInstance fonksiyonuna verilen **riid** ve **rclsid** değişkenleri üzerinden anlayabilirisiniz.

```assembly
 sub     esp, 24h
.text:00401003                 push    0               ; pvReserved
.text:00401005                 call    ds:OleInitialize
.text:0040100B                 test    eax, eax
.text:0040100D                 jl      short loc_401085
.text:0040100F                 lea     eax, [esp+24h+ppv]
.text:00401013                 push    eax             ; ppv
.text:00401014                 push    offset riid     ; riid
.text:00401019                 push    4               ; dwClsContext
.text:0040101B                 push    0               ; pUnkOuter
.text:0040101D                 push    offset rclsid   ; rclsid
.text:00401022                 call    ds:CoCreateInstance
.text:00401028                 mov     eax, [esp+24h+ppv]
.text:0040102C                 test    eax, eax
.text:0040102E                 jz      short loc_40107F
.text:00401030                 lea     ecx, [esp+24h+pvarg]
.text:00401034                 push    esi
.text:00401035                 push    ecx             ; pvarg
.text:00401036                 call    ds:VariantInit
.text:0040103C                 push    offset psz      ; "http://www.malwareanalysisbook.com/ad.h"...
.text:00401041                 mov     [esp+2Ch+var_10], 3
.text:00401048                 mov     [esp+2Ch+var_8], 1
.text:00401050                 call    ds:SysAllocString
.text:00401056                 lea     ecx, [esp+28h+pvarg]
.text:0040105A                 mov     esi, eax
.text:0040105C                 mov     eax, [esp+28h+ppv]
.text:00401060                 push    ecx
.text:00401061                 lea     ecx, [esp+2Ch+pvarg]
.text:00401065                 mov     edx, [eax]
.text:00401067                 push    ecx
.text:00401068                 lea     ecx, [esp+30h+pvarg]
.text:0040106C                 push    ecx
.text:0040106D                 lea     ecx, [esp+34h+var_10]
.text:00401071                 push    ecx
.text:00401072                 push    esi
.text:00401073                 push    eax
.text:00401074                 call    dword ptr [edx+2Ch]
.text:00401077                 push    esi             ; bstrString
.text:00401078                 call    ds:SysFreeString
.text:0040107E                 pop     esi
.text:0040107F
.text:0040107F loc_40107F:                             ; CODE XREF: _main+2E↑j
.text:0040107F                 call    ds:OleUninitialize
```

IDA Pro üzerinden riid ve rclsid değişkenlerinin tanımlı olduğu kısım aşağıdaki gibidir. 

```assembly
rdata:00402058 ; IID rclsid
.rdata:00402058 rclsid          dd 2DF01h               ; Data1
.rdata:00402058                                         ; DATA XREF: _main+1D↑o
.rdata:00402058                 dw 0                    ; Data2
.rdata:00402058                 dw 0                    ; Data3
.rdata:00402058                 db 0C0h, 6 dup(0), 46h  ; Data4
.rdata:00402068 ; IID riid
.rdata:00402068 riid            dd 0D30C1661h           ; Data1
.rdata:00402068                                         ; DATA XREF: _main+14↑o
.rdata:00402068                 dw 0CDAFh               ; Data2
.rdata:00402068                 dw 11D0h                ; Data3
.rdata:00402068                 db 8Ah, 3Eh, 0, 0C0h, 4Fh, 0C9h, 0E2h, 6Eh; Data4
```

Bu 2 ifadeyi uygun formata çevirmek gerekmektedir. Bunun için aşağıdaki fonksiyonu kullandım. Bu fonksiyona ve kullanımına [Bu linkten erişebilirisiniz.](https://reverseengineering.stackexchange.com/questions/17685/how-to-find-clsid-from-cocreateinstance-in-ida)

```C
#include <idc.idc>

static MakeGuid(ea)
{
    auto string = sprintf("{%08X-%04X-%04X-%02X%02X-%02X%02X%02X%02X%02X%02X}\n", 
        Dword(ea), Word(ea+4), Word(ea+6), Byte(ea+8), Byte(ea+9),
        Byte(ea+10), Byte(ea+11), Byte(ea+12), Byte(ea+13), Byte(ea+14), Byte(ea+15));
    Message(string);
    return 0;
}
```
Bu fonksiyon sonucunda IID değerimiz -> **{D30C1661-CDAF-11D0-8A3E-00C04FC9E26E}**
CLSID değerimiz -> **{0002DF01-0000-0000-C000-000000000046}**

şeklinde çıkmaktadır IID değeri **IWebBrowser2 interfacesini** CLSID değerimizde **Internet Explorer'ı** tanımlamaktadır. Windows'ta COM interfaceleri IID ile, sınıflar ise CLSID ile belirtilir. Windows'ta tüm CLSID'ler **HKML|HKCU/SOFTWARE/Classes/CLSID** yolunda bulunur.


**3- When will this program finish executing?**

Program belirtilen URL'ye bağlanıp, ekranda gösterdikten sonra sonlanacaktır.