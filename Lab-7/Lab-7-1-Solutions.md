# Lab7-1 Sorular

Bu lab uygulamasında `Practical Malware Analysis` kitabıyla birlikte verilmiş olan `Lab07-01.exe` dosyası üzerinden analiz gerçekleştirilecek ve sorulan sorularak cevaplar verilmeye çalışılacaktır. 

Bu içeriklerin amacı, direkt olarak sorulan sorulara cevap vermek değil, aynı zamanda malware analizi konusunda aydınlatıcı ve faydalı bir içerik havuzu oluşturmaktadır. Gerektiği yerlerde detaya girilecektir. Zaten kitabı aldıysanız, kitabın bir bölümü bu soruların cevaplarını detaylı bir şekilde veriyor. Burada amaç, cevapların içerisinde gizli kalmış, değinilmesi gereken konulara da değinerek bir fayda sağlabilmek. O halde başlayalım.

İlk sorumuz,

**1- How does this program ensure that it continues running(achives persistence) when the computer is restarted?**

Evet zararlımız persistence sağlamak için kendisini servis olarak infect olduğu makinaya eklemektedir. Zararlımızın bu işlemi yaptığını **OpenSCManager** ve **CreateService** API'lerini çağırmasından rahatlıkla anlayabiliriz. Bu 2 fonksiyon windows sistemlerde service oluşturmak ve modifiye etmek için kullanılmaktadır. Aşağıdaki görselde **dwStartType** ve **dwServiceType** değişkenleri bizlere servis hakkında ipuçları vermektedir. Mesela `StartType=0x02` olması bize bu servisin boot işlemi sırasında otomatik olarak çalıştırılacağını söylemektedir(AUTO_START). `ServiceType=0x10` değişkeni ise bu servisin başka bir process'e ihtiyaç duymadan kendisinin direkt olarak çalıştırılacağını söylemektedir. Yani svchost.exe gibi bir process tarafından run edilmez. Aşağıdaki görselde bu anlatılanlar gösterilmektedir.

![](/Lab-7/images/Lab7-1-image.png "lab7")

**2- Why does this program use a mutex?**

Bu zararlı, mutex işlemini reinfection olayını engellemek için kullanmaktadır. Normalde mutex dediğimiz yapı, threadler veya process arasında kullanılan shared memory'i organize etmek için kullanılmaktadır. Lakin genellikle malware'ler daha önceden enfekte olduğu bir sisteme tekrardan enfekte olmamak için `OpenMutex() fonksiyonunu` kullanırlar. Daha önceden enfekte olmadıysa OpenMutex() fonksiyonu NULL değer döner ve malware böylelikle enfekte olmadığını anlar. Aşağıda ilgili kısmın assembly kodu alınmıştır.

```assembly
.text:00401040                 sub     esp, 400h
.text:00401046                 push    offset Name     ; "HGL345"
.text:0040104B                 push    0               ; bInheritHandle
.text:0040104D                 push    1F0001h         ; dwDesiredAccess
.text:00401052                 call    ds:OpenMutexA
.text:00401058                 test    eax, eax
.text:0040105A                 jz      short loc_401064
.text:0040105C                 push    0               ; uExitCode
.text:0040105E                 call    ds:ExitProcess
```

**3- What is a good host-based signature to use for detecting this program?**

Zararlı tarafından oluşturulan mutex ismi ve persistence için kullanılan servis ismi önemli host-based inditicator'lerdir. Özetle aşağıdaki 2 indicator detection için kullanılabilir.

- Malservice (ServiceName)
- HGL345 (MutexName)

**4- What is a good network-based signature for detecting this malware?**

Zararlı bir thread ile internete bağlanmaktadır. Bağlanırken user-agent olarak `Internet Explorer 8.0`'ı kullanmakta ve `http://www.malwareanalysisbook.com` adresine bağlanmaktadır. Bu iki ifade network-based inditicator olarak kullanılabilir.

**5- What is the purpose of this program?**

Bu zararlı infecte olduğu sisteme kendisini servis olarak ekleyip persistence sağlamayı hedeflemekte. Ayrıca arkaplanda zararlı bir websitesi olan http://www.malwareanalysisbook.com adresine bağlanmaya çalışmaktadır. Ayrıca aşağıdaki kod bloğunda servis için bir zaman dilimi belirlenmektedir. Dikkat çekici olan kısım `SystemTime.wYear` değişkenine 2100 decimal değerinin atanmasıdır. Daha sonrasında CreateWaitableTimer fonksiyonu çağrılmıştır. Buradan bu uygulamanın 2100 yılına kadar bekleyeceği yorumu yapılabilir. Daha sonrasında threadler oluşturularak bahsi geçen URL'ye bağlanmaktadır.

```assembly
text:004010C2                 xor     edx, edx
.text:004010C4                 lea     eax, [esp+404h+FileTime]
.text:004010C8                 mov     dword ptr [esp+404h+SystemTime.wYear], edx
.text:004010CC                 lea     ecx, [esp+404h+SystemTime]
.text:004010D0                 mov     dword ptr [esp+404h+SystemTime.wDayOfWeek], edx
.text:004010D4                 push    eax             ; lpFileTime
.text:004010D5                 mov     dword ptr [esp+408h+SystemTime.wHour], edx
.text:004010D9                 push    ecx             ; lpSystemTime
.text:004010DA                 mov     dword ptr [esp+40Ch+SystemTime.wSecond], edx
.text:004010DE                 mov     [esp+40Ch+SystemTime.wYear], 2100
.text:004010E5                 call    ds:SystemTimeToFileTime
.text:004010EB                 push    0               ; lpTimerName
.text:004010ED                 push    0               ; bManualReset
.text:004010EF                 push    0               ; lpTimerAttributes
.text:004010F1                 call    ds:CreateWaitableTimerA
.text:004010F7                 push    0               ; fResume
.text:004010F9                 push    0               ; lpArgToCompletionRoutine
.text:004010FB                 push    0               ; pfnCompletionRoutine
.text:004010FD                 lea     edx, [esp+410h+FileTime]
```

**6- What will this program finish executing?**

Kod bloğu içerisinde ne zaman sonlanacağına dair bir ifade bulunmamaktadır.
